<h1>Welcome</h1>
<label>Your Name</label><input type="text" name="playerName" />
<fieldset id="dmOptions">
    <legend>DM the game</legend>
    <div class="hidden">DM Already Set</div>
    <button name="start" data-player_type="dm" disabled>Start</button>
</fieldset>
<fieldset id="playerOptions">
    <legend>OR Set up your character</legend>
    <label>Character's Name</label> <input type="text" name="characterName" />
    <label>Race</label>
        <!-- TODO: proper, dynamic list of races. -->
        <label for="race-human">Human</label><input id="race-human" type="radio" name="race" value="human" checked />
    <label>Walk Speed</label> <input type="number" name="speed" value="30" />
    <div class="ctrl-colourOption">
        <label>Colour</label>
        <input type="radio" id="red" value="FF0000" name="colour" checked />
        <label for="red">&nbsp;</label>

        <input type="radio" id="green" value="00FF00" name="colour" />
        <label for="green">&nbsp;</label>

        <input type="radio" id="blue" value="0000FF" name="colour" />
        <label for="blue">&nbsp;</label>

        <input type="radio" id="black" value="000000" name="colour" />
        <label for="black">&nbsp;</label>

        <input type="radio" id="cyan" value="00FFFF" name="colour" />
        <label for="cyan">&nbsp;</label>

        <input type="radio" id="magenta" value="FF00FF" name="colour" />
        <label for="magenta">&nbsp;</label>

        <input type="radio" id="yellow" value="FFFF00" name="colour" />
        <label for="yellow">&nbsp;</label>
        <input type="text" name="colour" />
    </div>
    <button name="start" data-player_type="player" disabled>Start</button>
</fieldset>
<fieldset>
   <button name="start" data-player_type="spectator">Spectate</button>
</fieldset>
<script type="application/javascript">
(function indexScript() {
    var onClickStart, onMessageReceived, onChangeInput,
        hideDmButton, buttons, inputs, i;

    document.body.setAttribute("data-state", "lobby");

    hideDmButton = function() {
        if (!mainEl) { return false;}
        el = mainEl.querySelector("#dmOptions > [name='start']");
        el.classList.add("hidden");

        el.parentNode.querySelector("div.hidden")
        .classList.remove("hidden");
        window.socket.removeEventListener("message", onMessageReceived);
        return true;
    };

    sendHttpRequest("session", "GET")
    .then(function(result) {
        var data = JSON.parse(result.responseText);
        if (data.is_dm_set) {
            wait(hideDmButton);
        }
    });

    /**
     * Enables start buttons as criteria are met
     */
    onChangeInput = function(event) {
        var dmButton, playerButton;
        dmButton = mainEl.querySelector("[name='start'][data-player_type='dm']");
        playerButton = mainEl.querySelector("[name='start'][data-player_type='player']");
        if (mainEl.querySelector("[name='playerName']").value) {
             dmButton.removeAttribute("disabled");
             dmButton.disabled = false;

             playerButton.removeAttribute("disabled");
             playerButton.disabled = !(document.querySelector("input[name='characterName']").value);
        } else {
            dmButton.disabled = true;
            playerButton.disabled = true;
        }
    };

    /**
     * Calls server to set up a session and a player.
     */
    onClickStart = function(event) {
        var body, result;
        body = {
            player_name : mainEl.querySelector("[name='playerName']").value,
            player_type : event.currentTarget.getAttribute("data-player_type")
        };

        if (body.player_type === "player") {
            body.character_name = mainEl.querySelector("[name='characterName']").value;
            body.colour = mainEl.querySelector("[name='colour'][type='text']").value ||
                mainEl.querySelector("input[name='colour']:checked").value;
            body.colour = body.colour.replace("#", "");
            body.speed = parseInt(mainEl.querySelector("[name='speed']").value);
        }

        if (window.sessionId) {
            result = sendHttpRequest("session/" + window.sessionId + "/player", "PUT", body);
        } else {
            result = sendHttpRequest("session", "POST")
            .then(function(result) {
                var data = JSON.parse(result.responseText || null);
                return sendHttpRequest("session/" + data.session_id + "/player", "PUT", body);
            });
        }

        result.then(function(result) {
            var result = JSON.parse(result.responseText);
            window.playerId = result.player_id.toString();
            switch(body.player_type) {
                case "dm":
                    document.body.setAttribute("data-isDm", "isDm");
                    return replaceBody("dm_console");
                case "player":
                    return replaceBody("ready");
                default:
                    return replaceBody("play");
            }
        })
        .catch(function() {
            delete window.sessionId;
            console.error();
        });
    };

    /**
     * Prevents more than one DM from signing up.
     */
    onMessageReceived = function(event) {
        var data, el;
        data = JSON.parse(event.data);
        if (data["dm_add"]) {
            hideDmButton();
        }
    };

    wait(function() {
        if (mainEl) {
            inputs = mainEl.querySelectorAll("input");
            for (i = 0; i < inputs.length; i++) {
                onEvent(inputs[i], "change", onChangeInput);
            }

            buttons = document.querySelectorAll("button[name='start']");
            for (i = 0; i < buttons.length; i++) {
                onEvent(buttons[i], "click", onClickStart);
            }
            onEvent(window.socket, "message", onMessageReceived);
            return true;
        }
        return false;
    });
})();
</script>