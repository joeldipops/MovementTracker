<h1>Welcome</h1>
<label>Your Name</label><input type="text" name="playerName" />
<fieldset id="dmOptions">
    <legend>DM the game</legend>
    <div class="hidden">DM Already Set</div>
    <button name="start" data-is_dm>Start</button>
</fieldset>
<fieldset id="playerOptions">
    <legend>OR Set up your character</legend>
    <label>Character's Name</label><input type="text" name="characterName" />
    <button name="start">Start</button>
</fieldset>
<script type="application/javascript">
(function indexScript() {
    var onClick, onMessage,
        hideDmButton, buttons, i;
        
    hideDmButton = function() {
        el = document.querySelector("#dmOptions > button[name='start']");
        el.classList.add("hidden");

        el.parentNode.querySelector("div.hidden")
        .classList.remove("hidden");
        window.socket.removeEventListener("message", onMessage);
    };

    sendHttpRequest("session", "GET")
    .then(function(result) {
        var data = JSON.parse(result.responseText);
        if (data.is_dm_set) {
            hideDmButton();
        }
    });
    
    /**
     * Calls server to set up a session and a player.
     */
    onClick = function(event) {
        var body, isDm;
        body = { 
            player_name : document.querySelector("input[name='playerName']").value,
        };

        isDm = event.currentTarget.hasAttribute("data-is_dm");
        if (isDm) {
            body.is_dm = true;
        } else {
            body.character_name = document.querySelector("input[name='characterName']").value;
        }

        if (window.sessionId) {
            sendHttpRequest("session/" + window.sessionId + "/player", "PUT", body);
        } else {
            sendHttpRequest("session", "POST")
            .then(function(result) {
                var data = JSON.parse(result.responseText || null);
                return sendHttpRequest("session/" + data.session_id + "/player", "PUT", body);        
            })
            .then(function() { })
            .catch(function() {
                debugger;
                console.error();
            });
        }
    };

    buttons = document.querySelectorAll("button[name='start']");
    for (i = 0; i < buttons.length; i++) {
        onEvent(buttons[i], "click", onClick);
    }

    /**
     * Prevents more than one DM from signing up.
     */
    onMessage = function(event) {
        var data, el;
        data = JSON.parse(event.data);
        if (data["dm_add"]) {
            hideDmButton();
        }
    };
    onEvent(window.socket, "message", onMessage);
})();
</script>
