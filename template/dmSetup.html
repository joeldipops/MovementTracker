<article id="setup">
    <h3></h3>
    <table id="map" class="ctrl-combatMap" data-state="">
    </table>
</article>
<script id="template-controls" type="text/html">
<fieldset id="mapOptions">
    <legend>Set Map</legend>
    <label for="mapWidth">Width</label>
    <input id="mapWidth" type="number" name="mapWidth" value="12" />
    <label for="mapHeight">Height</label>
    <input id="mapHeight" type="number" name="mapHeight" value="12" />
    <button name="generateMap">Resize</button>
</fieldset>
<fieldset id="mobOptions">
    <legend>Add NPC</legend>
    <ul class="ctrl-colourOption">
        <li>
            <button name="addNpc">+</button>
            <div>
                <label for="npcName">Name</label>
                <input type="text" id="npcName" name="npcName" />
            </div>
            <div>
                <label for="npcInitiative">Initiative</label>
                <input type="number" id="npcInitiative" name="npcInitiative" value="10" />
            </div>
            <div>
                <label for="npcSpeed">Walk Speed</label>
                <input type="number" id="npcSpeed" name="npcSpeed" value="30" />
            </div>
            <div>
                <label for="npcSize">Size</label>
                <select id="npcSize" name="npcSize"></select>
            </div>
        </li>
    </ul>
</fieldset>
<fieldset id="terrainOptions">
    <legend>Add Terrain</legend>
    <ul class="ctrl-colourOption" name="terrainTypes"></ul>
    <div>
        <label for="terrainWidth">Width</label>
        <input type="number" id="terrainWidth" name="terrainWidth" value="1" />
    </div>
    <div>
        <label for="terrainLength">Length</label>
        <input type="number" id="terrainLength" name="terrainLength" value="1" />
    </div>
</fieldset>
<strong><button name="start">Start</button></strong>
<button name="clear">Reset Map</button>
<button name="reset">Reset Entire Session</button>
</script>
<script id="template-terrainType" type="text/html">
    <li>
        <input type="radio" id="terrainType-{type}" name="terrainType" value="{type}" />
        <label class="{type}" for="terrainType-{type}"></label>
        <label for="terrainType-{type}">{text}</label>
    </li>
</script>
<script id="template-combatCell" type="text/html">
<td class="ctrl-combatCell">
    <button class="terrain">&nbsp;</button>
</td>
</script>
<script type="application/javascript">
loadExternalScript("public/combatMap.js");
</script>
<script type="application/javascript">
(function setupScript() {
    var i,
        clear, start, reset, renderMenu, addTerrain, addMob, moveMob, removeMob, generateMap,
        onPositionClicked,
        controlsTemplate, mapCellTemplate;

    /**
     * Resets the map to a blank slate.
     */
    clear = function() {
        var map;
        pageContext.removeMapEvents();
        map = document.getElementById("map");
        map.removeAttribute("data-width");
        map.removeAttribute("data-height");
        while(map.firstChild) {
            map.removeChild(map.firstChild);
        }
    };

    /**
     * Uploads and broadcasts map, then takes you to the main screen.
     */
    start = function() {
        var requestBody;
        requestBody = pageContext.mapToJSON();
        sendHttpRequest("session/" + window.sessionId + "/map", "PUT", requestBody)
        .then(function() {
            return replaceBody("play");
        })
        .catch(function(res) {
            if(res.status) {
                console.error(res.status, res.responseText);
            } else {
                console.error(JSON.stringify(res));
            }
        });
    };

    /**
     * Deletes the session and goes back to the lobby page.
     */
    reset = function() {
        if (window.sessionId) {
            sendHttpRequest("session/" + window.sessionId, "DELETE")
            .then(function(res) {
                replaceBody("home", document.documentElement);
            })
        .   catch(function(res) {
                console.error(res.status, res.responseText);
            });
        } else {
            replaceBody("home", document.documentElement);
        }
        document.body.removeAttribute("data-isDm");
        delete window.sessionId;
    };

    /** 
     * Moves mob with id from one location to another
     */
    moveMob = function(data, event) {
        var mob;
        mob = pageContext.getMobWithId(data.id);
        if (mob) {
            pageContext.removeMob(mob);
        }
        addMob(clone(data), event)
    };

    /**
     * Adds a new MOB to the map.
     * @param {object} data describing the mob.
     * @param {DOMEvent} event The click event describing where to add the terrain.
     */
    addMob = function(data, event) {
        var x, y, size, extant, mapSize,
            i, j, el, container, orig;

        orig = data;
        data = clone(data);
        // only use this ID the first time.
        delete orig.id

        if (!data.id) {
            data.id = (new Date()).valueOf().toString();
            delete data.order;
            initiativeContext.addMob(data);
        }

        x = parseInt(event.currentTarget.getAttribute("data-x"));
        y = parseInt(event.currentTarget.getAttribute("data-y"));

        size = pageContext.mobSizes[data.size];
        extant = pageContext.getMob(x, y);

        for (i = 0; i < (extant ? extant.length : 0); i++) {
            // TODO - figure out the rules for this.
            // "a creature cannot enter the same space of another of the same size or smaller?"
            // Not quite right, but gives something to work with.
            if (size.rank <= pageContext.mobSizes[extant[i].size].rank) {
                return
            }
        }

        mapSize = pageContext.getSize();
        maxX = mapSize.width;
        maxY = mapSize.height;

        for (i = x; i < x + size.tiles && i <= maxX; i++) {
            for (j = y; j < y + size.tiles && j <= maxY; j++) {
                // Needs A LOT of design work on what to do with larger creatures & multiple 
                // creatures on a tile...
                pageContext.setMob(i, j, data);
            }
        }
    };

    /**
     * Adds a terrain to the map.
     * @param {DOMEvent} event The click event describing where to add the terrain.
     */
    addTerrain = function(event) {
        var x, y, X, Y, width, height, type,
            el, maxX, maxY;

        x = parseInt(event.currentTarget.getAttribute("data-x"));
        y = parseInt(event.currentTarget.getAttribute("data-y"));
        width = parseInt(document.querySelector("[name='terrainWidth']").value);
        height = parseInt(document.querySelector("[name='terrainLength']").value);
        type = document.querySelector("[name='terrainType']:checked").value;

        mapSize = pageContext.getSize();
        maxX = mapSize.width;
        maxY = mapSize.height;

        for (X = x; X < (x + width) && X <= maxX; X++) {
            for(Y = y; Y < (y + height) && Y <= maxY; Y++) {
                pageContext.setTerrain(X, Y, type);
            }
        }
    };

    /**
     * Generates a grid based on the user's request.
     */
    generateMap = function() {
        var width, height;
        width = parseInt(document.querySelector("[name='mapWidth']").value);
        height = parseInt(document.querySelector("[name='mapHeight']").value);
        clear();
        pageContext.renderMap({
            width: width,
            height: height
        }, mapCellTemplate);
    };

    onPositionClicked = function(data) {
        pageContext.removeMapEvents();
        pageContext.onMapEvent("td > button", "click", moveMob.bind({}, data));
    };

    /**
     * Renders controls in the menu container.
     */
    renderMenu = function() {
        var menu, el, i, option;
        menu = document.getElementById("controls");
        menu.insertAdjacentHTML("beforeend", controlsTemplate);

        // NPC creature sizes.
        el = menu.querySelector("#mobOptions [name='npcSize']");
        for (i in pageContext.mobSizes) {
            option = document.createElement("option");
            option.setAttribute("value", i);
            option.innerHTML = pageContext.mobSizes[i].text;
            option.selected = (i === "medium");
            el.appendChild(option);
        }

        el = menu.querySelector("#terrainOptions > ul[name='terrainTypes']");
        // Terrain type radio buttons.
        for (i in pageContext.terrainTypes) {
            option = document.getElementById("template-terrainType").innerHTML;
            option = option.replace(/{type}/g, i)
                .replace(/{text}/g, pageContext.terrainTypes[i].text);
            el.insertAdjacentHTML("beforeend", option);
        }

        // When add npc is clicked, we can select a cell to add them to.
        onEvent("button[name='addNpc']", "click", function() {
            var name, init, size;
            name = document.querySelector("[name='npcName']").value;
            init = parseInt(document.querySelector("[name='npcInitiative']").value);
            
            // Can't add NPC if missing info.
            if (!name || isNaN(init)) {
                return;
            }

            data = {
                character_name : name,
                initiative : init,
                size : document.querySelector("[name='npcSize']").value,
                speed : {
                    walk : document.querySelector("[name='npcSpeed']").value
                },
                id : (new Date()).valueOf().toString()
            };

            initiativeContext.addMob(data);

            pageContext.removeMapEvents();
            // the data that we bind the the map event
            pageContext.onMapEvent("td > button", "click", addMob.bind({}, data));
        });

        // When position/location button is clicked for a mob, we can select a cell.
        initiativeContext.onListEvent("position", onPositionClicked);

        // When in set up mode, deleting an NPC gets rid of it completely.
        initiativeContext.onListEvent("toggleMob", function(data) {
            pageContext.removeMapEvents();
            pageContext.removeMob(data);
            if (data.mob_type === "npc") {
                initiativeContext.removeMob(data);
            } else {
                onPositionClicked(data);
            }
        });
        
        // When terrain type is selected, we can add a terrain to a cell.
        onEvent("input[name='terrainType']", "change", function() {
            pageContext.removeMapEvents();
            pageContext.onMapEvent("td > button", "click", addTerrain);
        });

        onEvent("button[name='generateMap']", "click", generateMap);

        onEvent("button[name='clear']", "click", clear);

        onEvent("button[name='start']", "click", start);

        onEvent("button[name='reset']", "click", reset);
    };

    document.body.setAttribute("data-state", "setup");
    controlsTemplate = document.getElementById("template-controls").innerHTML;
    mapCellTemplate = document.getElementById("template-combatCell").innerHTML;

    wait(function() {
        if (pageContext.terrainTypes) {
            renderMenu();
            generateMap();
            return true;
        } else {
            return false;
        }
    });
})();
</script>