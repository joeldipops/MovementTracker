<section>
    <h2>Ready Players</h2>
    <div>Waiting for DM</div>
    <ol class="initiativeList"></ol>
</section>
<script id="template-initiativeListItem" type="text/html">
<li class="mob" data-id="" data-mobType="" data-initiative="">
    <span class="initiativeScore"></span>
    <span class="mobName"></span>
    <span class="usedReaction">No</span>
    <button name="position">loc</span>
    <button name="react">react</button>
    <button name="toggleMob">x</button>
</li>
</script>
<script type="application/javascript">
window.initiativeContext = {};
(function socialScript() {
    var onReceiveMessage, onClose, bindInputEvents,
        addPlayer, removePlayer, addDM, removeDM,
        template, _listEl, _subscribers, _events;

    _listEl = document.querySelector("#social ol.initiativeList");
    _subscribers = {};
    _events = [];

    template = document.querySelector("#template-initiativeListItem").innerHTML;

    /**
     * Cleans up bound events.
     */
    onClose = function() {
        window.socket.removeEventListener("message", onReceiveMessage);
        _subscribers = {};
        
        for (i = 0; i < _events.length; i++) {
            _events[i]();
        }
        _events = [];
    };

    /**
     * Ensures click etc events will fire for each item in the list.
     * @param {HTMLElement} The list item with buttons to bind.
     */
     bindInputEvents = function(li) {
         var buttons, handler;
         buttons = li.querySelectorAll("button");
         handler = fireEvent.bind({}, li);
         for (i = 0; i < buttons.length; i++) {
             buttons[i].addEventListener("click", handler);
             _events.push(buttons[i].removeEventListener.bind(buttons[i], "click", handler));
         }
     };

     /**
      * Calls subscribing callbacks.
      * @param {HTMLElement} li parentNode of the clicked element.
      * @param {DOMElement} event that occured.
      */
     fireEvent = function(li, event) {
         var name, data, i;
         name = event.currentTarget.getAttribute("name");
         if (_subscribers[name] && _subscribers[name].length) {
            data = {};
            data.id = li.getAttribute("data-id");
            data.size = li.getAttribute("data-size");
            data.mob_type = li.getAttribute("data-mobtype");
            data.colour = li.style.color;
            data.character_name = li.querySelector(".mobName").innerHTML;
            data.initiative = parseInt(li.getAttribute("data-initiative"));

            for (i = 0; i < _subscribers[name].length; i++) {
                _subscribers[name][i](data);
            }
         }
     };

    /**
     * Handles messages received through the web socket.
     * @param {object} event that occured.
     */
    onReceiveMessage = function(event) {
        var data, el;
        data = JSON.parse(event.data);
        if (data["player_add"]) {
            addPlayer(data["player_add"]);
        }
        if (data["player_update"]) {
            addPlayer(data["player_update"], true);
        }
        if (data["player_remove"]) {
            removePlayer(data["player_remove"]);
        }
        if (data["dm_add"]) {
            addDM(data["dm_add"]); 
        }
        if (data["dm_remove"]) {
            removeDM();
        }
        if (data["session_id"]) {
            refreshList();
        }

    };

    /**
     * Sets the name of the DM in the display.
     * @param {object} data describing dm.
     */
    addDM = function(data) {
        var el = document.querySelector("#social > section > div");
        el.innerHTML = "DM is " + data.player_name;
    };

    /**
     * Reverts the dm display if they leave.
     */
    removeDM = function(data) {
        var el = document.querySelector("#social > section > div");
        el.innerHTML = "Waiting for DM";
    };

    /**
     * Removes a mob from the list.
     * @param {object} data describes the mob.
     */
    removePlayer = function(data) {
        var li, id;
        id = isNaN(data.player_id) ? data.id : data.player_id;
        if (li = _listEl.querySelector("li[data-id='" + id + "']")) {
            li.parentElement.removeChild(li);
        }
    };

    /**
     * Removes all mobs from the list.
     */
    removeAll = function() {
        while (_listEl.firstChild) {
            _listEl.removeChild(_listEl.firstChild);
        }
    };

    /**
     * Adds a mob to the list, by correct sort order.
     * @param {object} data describing the player
     * @param {boolean} isUpdate true if updating a player already in the list.
     */
    addPlayer = function(data, isUpdate) {
        var list, li, fragment,
            inserted, i, extant, init;
        if (!isNaN(data.player_id)) {
            data.id = data.player_id
        }

        // Don't add same player more than once.
        li = _listEl.querySelector("li[data-id='" + data.id + "']");
        if (!li) {
            // probably would be faster to manipulate the template than the element...
            fragment = document.createDocumentFragment();
            fragment.appendChild(document.createElement("span"));
            fragment.firstElementChild.insertAdjacentHTML("beforeend", template);
            li = fragment.firstElementChild.firstElementChild;
        } else if (!isUpdate) {
            return;
        } else {
            inserted = true;
        }

        li.setAttribute("data-id", data.id);
        li.setAttribute("data-mobType", isNaN(data.player_id) ? "npc" : "pc");

        if (data.colour) { li.style.color = "#" + data.colour; }
        if (data.size) { li.setAttribute("data-size", data.size); }
        if (data.character_name) { li.querySelector(".mobName").innerHTML = data.character_name; }

        if (!isNaN(data.initiative)) {
            inserted = false;
            li.parentNode.removeChild(li);
            li.querySelector(".initiativeScore").innerHTML = data.initiative;
            li.setAttribute("data-initiative", data.initiative);

            extant = _listEl.querySelectorAll("li.mob");
            for (i = 0; i < extant.length; i++) {
                init = parseInt(extant[i].getAttribute("data-initiative"));
                if (data.initiative > init) {
                    _listEl.insertBefore(li, extant[i]);
                    inserted = true;
                    break;
                } else if (data.initiative === init) {
                    // Later rollers go later in the list.
                    _listEl.insertBefore(li, extant[i+1]);
                    inserted = true;
                    break;
                }
            }
        } else {

        }

        // If initiative not set, just append to the end.
        if (!inserted) {
            _listEl.appendChild(li);
        }
        bindInputEvents(li);
    };

    /**
     * Clears the list of names and gets a fresh list from the server.
     */
    refreshList = function() {
        return sendHttpRequest("session/" + window.sessionId + "/players", "GET", null, { isPersistent : true })
        .then(function(result){
            var i, players;
            result = JSON.parse(result.responseText);
            if (!result || !result.players) {
                throw "No players";
            }

            players = result.players;
            for (i = 0; i < players.length; i++) {
                switch (players[i].player_type) {
                    case "dm": addDM(players[i]); break;
                    case "player": addPlayer(players[i]); break;
                    default: break;
                }
            }
        })
        .catch(function(err) {
            console.error(JSON.stringify(err));
        });
    };
    if(window.sessionId) {
        refreshList();
    }

    window.socket.addEventListener("message", onReceiveMessage);
    window.initiativeContext.addMob = addPlayer;
    window.initiativeContext.removeMob = removePlayer;

    /**
     * Subscribes to an event triggered by some operation or interation on the list.
     * @param {string} event The name of the event.
     * @param {function} handler The callback.
     */
    window.initiativeContext.onListEvent = function(event, handler) {
        if (!_subscribers[event]) {
            _subscribers[event] = [];
        }

        _subscribers[event].push(handler);
    };

    /**
     * Removes a handler from the list of subscribers.
     * @param {string} event to unsubsribe from.
     * @param {function} handler to remove.
     */
    window.initiativeContext.offListEvent = function(event, handler) {
        var i;
        if (!_subscribers[event]) {
            return;
        }

        if((i = _subscribers[event].indexOf(handler)) >= 0) {
            _subscribers[event].splice(i, 1);
        }
    };

    /**
     * Reorders the list based on initiative.
     */
    window.initiativeContext.orderList = function() {
        var listItems, temp, i, ordered, comparator;
        listItems = _listEl.querySelectorAll("li.mob");
        // Convert node list in to array.
        temp = [];
        for (i = 0; i < listItems.length; i++) {
            temp.push(listItems[i]);
        }
        listItems = temp;

        ordered = [];
        while(listItems.length > 0) {
            if (!ordered.length) {
                ordered.push(listItems[0]);
            } else {
                comparator = parseInt(listItems[0].getAttribute("data-initiative"));
                i = 0;
                while(
                    i < ordered.length
                    && comparator <= parseInt(ordered[i].getAttribute("data-initiative"))
                ) {
                    // <= preferences earlier entries.
                    i++;
                }
                ordered.splice(i, 0, listItems[0]);
            }
            listItems.shift();
        }

        while(_listEl.firstElementChild) {
            _listEl.removeChild(_listEl.firstElementChild);
        }
        for(i = 0; i < ordered.length; i++) {
            _listEl.appendChild(ordered[i]);
        }
    };
})();

</script>

