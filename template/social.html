<section>
    <h2>Ready Players</h2>
    <div>Waiting for DM</div>
    <ol class="initiativeList"></ol>
</section>
<script id="template-initiativeListItem" type="text/html">
<li data-id="" data-mob_type="">
    <span class="initiativeScore"></span>
    <span class="mobName"></span>
    <span class="usedReaction">No</span>
    <button name="position">loc</span>
    <button name="react">react</button>
    <button name="toggleMob">0HP</button>
</li>
</script>
<script type="application/javascript">
(function socialScript() {
    var onReceiveMessage, onClose, 
        addPlayer, removePlayer, addDM, removeDM,
        template;

    template = document.querySelector("#template-initiativeListItem").innerHTML;        
    
    /**
     * Cleans up bound events.
     */
    onClose = function() {
        window.socket.removeEventListener("message", onReceiveMessage);
    };

    /**
     * Handles messages received through the web socket.
     */
    onReceiveMessage = function(event) {
        var data, el;
        data = JSON.parse(event.data);
        if (data["player_add"]) {
            addPlayer(data["player_add"]);    
        }
        if (data["player_remove"]) {
            removePlayer(data["player_remove"]);
        }
        if (data["dm_add"]) {
            addDM(data["dm_add"]); 
        }
        if (data["dm_remove"]) {
            removeDM();
        }
        if (data["session_id"]) {
            refreshList();
        }
        
    };
    
    addDM = function(data) {
        var el = document.querySelector("#social > section > div");
        el.innerHTML = "DM is " + data.player_name;
    };
    
    removeDM = function(data) {
        var el = document.querySelector("#social > section > div");
        el.innerHTML = "Waiting for DM";     
    };
    
    removePlayer = function(data) {
        var li;
        if (li = document.querySelector("#social li[data-id='" + data.player_id + "']")) {
            li.parentElement.removeChild(li);
        }
    };
    
    removeAll = function() {
        var list = document.querySelector("#social > section > div > ul")
        while (list.firstChild) {
            list.removeChild(list.firstChild);
        }
    };
    
    addPlayer = function(data) {
        var list, li;
        // Don't add same player more than once.
        if (li = document.querySelector("#social li[data-id='" + data.player_id + "']")) {
            return;
        }
        list = document.querySelector("#social ol.initiativeList");
        list.insertAdjacentHTML("beforeend", template);
        li = list.lastElementChild;
        li.style.color = "#" + data.colour;
        
        li.setAttribute("data-id", data.player_id);
        li.querySelector(".mobName").innerHTML = data.character_name;
    };

    /**
     * Clears the list of names and gets a fresh list from the server.
     */
    refreshList = function() {
        return sendHttpRequest("session/" + window.sessionId + "/players", "GET", null, { isPersistent : true })
        .then(function(result){
            var i, players;
            result = JSON.parse(result.responseText);
            if (!result || !result.players) {
                throw "No players";
            }
        
            players = result.players;
            for (i = 0; i < players.length; i++) {
                switch (players[i].player_type) {
                    case "dm": addDM(players[i]); break;
                    case "player": addPlayer(players[i]); break;
                    default: break;
                }
            }
        })
        .catch(function(err) {
            console.error(JSON.stringify(err));
        });
    };
    if(window.sessionId) {
        refreshList();
    }
    
    window.socket.addEventListener("message", onReceiveMessage);
})();

</script>

